<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Tracker – Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="navbar">
      <div class="nav-left">
        <div class="nav-logo">L</div>
        <div>
          <div class="nav-title">Library Book Tracker</div>
          <div class="nav-subtitle">Linked List backend in C · MongoDB · Node.js</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link active">Dashboard</a>
        <a href="add.html" class="nav-link">Add Book</a>
        <a href="issue.html" class="nav-link">Issue</a>
        <a href="return.html" class="nav-link">Return</a>
        <a href="delete.html" class="nav-link">Delete</a>
      </nav>
    </header>

    <main>
      <div class="page-header">
        <div class="page-title">Dashboard</div>
        <div class="page-subtitle">
          Visual view of the current linked list of books managed by the C backend.
        </div>
      </div>

      <div class="layout-two-col">
        <section class="card">
          <h3 style="margin:0 0 8px;font-size:15px;">Highlight & Refresh</h3>
          <p class="small-muted">
            Use this panel to quickly jump to a particular node and reload the list from the backend.
          </p>

          <div class="form-group">
            <label for="highlightId">Book ID to highlight</label>
            <input type="number" id="highlightId" />
          </div>
          <div class="btn-row">
            <button class="btn" id="highlightBtn" type="button">Highlight</button>
            <button class="btn secondary" id="refreshBtn" type="button">Refresh List</button>
          </div>

          <div id="dashMessage" class="status-message success"></div>
          <div id="dashError" class="status-message error"></div>

          <p class="small-muted" style="margin-top:10px;">
            Tip: Use the operations from the other pages and then refresh here to see how the linked list changes.
          </p>
        </section>

        <section>
          <div class="card">
            <div class="visualizer-container">
              <div class="list-info" id="listInfo">Loading list from server...</div>
              <div class="nodes-wrapper" id="nodesWrapper"></div>
            </div>
            <div class="legend">
              <span>
                <span class="legend-box" style="background:#ffffff;border:1px solid #e5e7eb;"></span>
                Normal book
              </span>
              <span>
                <span class="legend-box" style="background:#fef2f2;border:1px solid rgba(185,28,28,0.6);"></span>
                Out of stock
              </span>
              <span>
                <span class="legend-box" style="background:#ffffff;border:1px solid rgba(37,99,235,0.8);"></span>
                Highlighted
              </span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "http://localhost:3000/api";

    const nodesWrapper = document.getElementById("nodesWrapper");
    const listInfo = document.getElementById("listInfo");
    const dashMsg = document.getElementById("dashMessage");
    const dashErr = document.getElementById("dashError");
    const highlightInput = document.getElementById("highlightId");
    const highlightBtn = document.getElementById("highlightBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    function setMsg(msg) {
      dashMsg.textContent = msg || "";
    }

    function setErr(msg) {
      // ❗ This will now stay until you explicitly overwrite it
      dashErr.textContent = msg || "";
    }

    async function loadBooks() {
      try {
        // IMPORTANT: don't auto-clear the error here,
        // so "not found" messages stay unless user does some other action
        setMsg("Fetching latest list from backend...");
        const res = await fetch(`${API_BASE}/books`);
        const data = await res.json();
        renderLinkedList(data);
        setMsg("List refreshed.");
      } catch (err) {
        console.error(err);
        setErr("Failed to load books.");
        listInfo.textContent = "Error loading list.";
      }
    }

    function renderLinkedList(books) {
      nodesWrapper.innerHTML = "";

      if (!books || books.length === 0) {
        listInfo.textContent = "List is empty. (head = NULL)";
        const nullSpan = document.createElement("span");
        nullSpan.className = "null-node";
        nullSpan.textContent = "NULL";
        nodesWrapper.appendChild(nullSpan);
        return;
      }

      listInfo.textContent = "head →";

      books.forEach((book, idx) => {
        const nodeDiv = document.createElement("div");
        nodeDiv.className = "book-node";
        if (book.available === 0) nodeDiv.classList.add("out-of-stock");
        nodeDiv.dataset.bookId = book.id;

        const header = document.createElement("div");
        header.className = "book-node-header";
        header.textContent = `ID: ${book.id}`;
        nodeDiv.appendChild(header);

        const tDiv = document.createElement("div");
        tDiv.className = "book-field";
        tDiv.textContent = `Title: ${book.title}`;
        nodeDiv.appendChild(tDiv);

        const aDiv = document.createElement("div");
        aDiv.className = "book-field";
        aDiv.textContent = `Author: ${book.author}`;
        nodeDiv.appendChild(aDiv);

        const cDiv = document.createElement("div");
        cDiv.className = "book-field";
        cDiv.textContent = `Category: ${book.category}`;
        nodeDiv.appendChild(cDiv);

        const copiesDiv = document.createElement("div");
        copiesDiv.className = "book-field";
        copiesDiv.textContent = `Avail/Total: ${book.available}/${book.total}`;
        nodeDiv.appendChild(copiesDiv);

        nodesWrapper.appendChild(nodeDiv);

        if (idx !== books.length - 1) {
          const arrowSpan = document.createElement("span");
          arrowSpan.className = "arrow";
          arrowSpan.textContent = "→";
          nodesWrapper.appendChild(arrowSpan);
        }
      });

      const nullSpan = document.createElement("span");
      nullSpan.className = "null-node";
      nullSpan.textContent = "→ NULL";
      nodesWrapper.appendChild(nullSpan);
    }

    function highlightById(id) {
      const allNodes = nodesWrapper.querySelectorAll(".book-node");
      allNodes.forEach(n => n.classList.remove("highlight"));

      if (!id || isNaN(id)) {
        setErr("Enter a valid Book ID.");
        return;
      }

      let found = false;
      allNodes.forEach(n => {
        if (parseInt(n.dataset.bookId) === id) {
          n.classList.add("highlight");
          n.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
          found = true;
        }
      });

      if (!found) {
        // ❗ This will remain until you manually overwrite/clear it
        setErr(`Book with ID ${id} not found in current list.`);
        // we do NOT clear setMsg here so success text stays separate
      } else {
        // On success, clear previous error and show success message
        setErr("");
        setMsg(`Highlighted book with ID ${id}.`);
      }
    }

    highlightBtn.addEventListener("click", () => {
      const id = parseInt(highlightInput.value);
      highlightById(id);
    });

    refreshBtn.addEventListener("click", loadBooks);

    window.addEventListener("DOMContentLoaded", loadBooks);
  </script>
</body>
</html>
