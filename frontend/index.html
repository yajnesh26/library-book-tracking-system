<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Tracker – Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="navbar">
      <div class="nav-left">
        <div class="nav-logo">
          <img src="../images/logo.png" alt="Logo">
        </div>
        <div>
          <div class="nav-title">Library Book Tracker</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link active">Dashboard</a>
        <a href="add.html" class="nav-link">Add Book</a>
        <a href="issue.html" class="nav-link">Issue</a>
        <a href="return.html" class="nav-link">Return</a>
        <a href="delete.html" class="nav-link">Delete</a>
        <a href="borrowers.html" class="nav-link">Borrowers</a>
      </nav>
    </header>

    <main>
      <div class="page-header">
      </div>

      <div class="layout-two-col">
        <section class="card">
          <h3 style="margin:0 0 8px;font-size:20px;border-bottom: 2px solid #050505;">Highlight & Refresh</h3>

          <div class="form-group">
            <label style="font-size: 15px;" for="highlightId">Book ID to highlight</label>
            <input style="margin-top: 10px;" type="number" id="highlightId" min="0" step="1" inputmode="numeric"/>
          </div>
          <div class="btn-row">
            <button class="btn" id="highlightBtn" type="button">Highlight</button>
            <button class="btn secondary" id="refreshBtn" type="button">Refresh List</button>
          </div>

          <div id="dashMessage" class="status-message success"></div>
          <div id="dashError" class="status-message error"></div>

        </section>

        <section>
          <div class="card" style="background-color: grey;">
            <div class="visualizer-title" style="border-bottom: 2px solid #050505;font-weight: 700;">Linked-List Visualization</div>
            <div class="visualizer-container" style="background-color: rgb(211, 221, 178)">
              <div class="list-info" id="listInfo">Loading list from server...</div>
              <div class="nodes-wrapper" id="nodesWrapper"></div>
            </div>
            <div class="legend">
              <span style="color: white;font-size: 14px;">
                <span class="legend-box" style="background:#ffffff;border:1px solid #e5e7eb;"></span>
                Normal book
              </span>
              <span style="color: white;font-size: 14px;">
                <span class="legend-box" style="background:#fef2f2;border:1px solid rgba(185,28,28,0.6);"></span>
                Out of stock
              </span>
              <span style="color: white;font-size: 14px;">
                <span class="legend-box" style="background:#ffffff;border:1px solid rgba(37,99,235,0.8);"></span>
                Highlighted
              </span>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "http://localhost:3000/api";

    const nodesWrapper = document.getElementById("nodesWrapper");
    const listInfo = document.getElementById("listInfo");
    const dashMsg = document.getElementById("dashMessage");
    const dashErr = document.getElementById("dashError");
    const highlightInput = document.getElementById("highlightId");
    const highlightBtn = document.getElementById("highlightBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    function setMsg(msg) {
      dashMsg.textContent = msg || "";
      if (msg) {
    setTimeout(() => {
      dashMsg.textContent = "";
    }, 2000);
  }
    }

    function setErr(msg) {
      // ❗ This will now stay until you explicitly overwrite it
      dashErr.textContent = msg || "";
    }

    async function loadBooks() {
      try {
        // IMPORTANT: don't auto-clear the error here,
        // so "not found" messages stay unless user does some other action
        setMsg("Fetching latest list from backend...");
        const res = await fetch(`${API_BASE}/books`);
        const data = await res.json();
        renderLinkedList(data);
        setMsg("List refreshed.");
      } catch (err) {
        console.error(err);
        setErr("Failed to load books.");
        listInfo.textContent = "Error loading list.";
      }
    }

    function renderLinkedList(books) {
      nodesWrapper.innerHTML = "";

      if (!books || books.length === 0) {
        listInfo.textContent = "List is empty. (head = NULL)";
        const nullSpan = document.createElement("span");
        nullSpan.className = "null-node";
        nullSpan.textContent = "NULL";
        nodesWrapper.appendChild(nullSpan);
        return;
      }

      listInfo.textContent = "head →";

      books.forEach((book, idx) => {
        const nodeDiv = document.createElement("div");
        nodeDiv.className = "book-node";
        if (book.available === 0) nodeDiv.classList.add("out-of-stock");
        nodeDiv.dataset.bookId = book.id;

        const header = document.createElement("div");
        header.className = "book-node-header";
        header.textContent = `ID: ${book.id}`;
        nodeDiv.appendChild(header);

        const tDiv = document.createElement("div");
        tDiv.className = "book-field";
        tDiv.textContent = `Title: ${book.title}`;
        nodeDiv.appendChild(tDiv);

        const aDiv = document.createElement("div");
        aDiv.className = "book-field";
        aDiv.textContent = `Author: ${book.author}`;
        nodeDiv.appendChild(aDiv);

        const cDiv = document.createElement("div");
        cDiv.className = "book-field";
        cDiv.textContent = `Category: ${book.category}`;
        nodeDiv.appendChild(cDiv);

        const copiesDiv = document.createElement("div");
        copiesDiv.className = "book-field";
        copiesDiv.textContent = `Avail/Total: ${book.available}/${book.total}`;
        nodeDiv.appendChild(copiesDiv);

        nodesWrapper.appendChild(nodeDiv);

        if (idx !== books.length - 1) {
          const arrowSpan = document.createElement("span");
          arrowSpan.className = "arrow";
          arrowSpan.textContent = "→";
          nodesWrapper.appendChild(arrowSpan);
        }
      });

      const nullSpan = document.createElement("span");
      nullSpan.className = "null-node";
      nullSpan.textContent = "→ NULL";
      nodesWrapper.appendChild(nullSpan);
    }

    // Helper: allow navigation and control keys
    const isControlKey = (ev) => {
      const allowed = [
        "Backspace","ArrowLeft","ArrowRight","Delete","Tab","Home","End"
      ];
      return allowed.includes(ev.key) || (ev.ctrlKey || ev.metaKey);
    };

    highlightInput.addEventListener("keydown", (ev) => {
      // block letters like "e", "E", "+", "-", ".", and other non-digit keys
      if (isControlKey(ev)) return; // allow navigation & copy/paste etc.

      // Allow digits 0-9
      if (ev.key >= "0" && ev.key <= "9") return;

      // otherwise prevent the key
      ev.preventDefault();
    });

    highlightInput.addEventListener("paste", (ev) => {
      // sanitize pasted content: allow only digits
      const text = (ev.clipboardData || window.clipboardData).getData("text");
      if (!/^\d+$/.test(text)) {
        ev.preventDefault();
        // Optionally insert sanitized version:
        const sanitized = text.replace(/\D+/g, "");
        if (sanitized) {
          // insert sanitized text at cursor position
          const start = highlightInput.selectionStart;
          const end = highlightInput.selectionEnd;
          const val = highlightInput.value;
          highlightInput.value = val.slice(0, start) + sanitized + val.slice(end);
          highlightInput.setSelectionRange(start + sanitized.length, start + sanitized.length);
        }
      }
    });

    highlightBtn.addEventListener("click", () => {
      const raw = highlightInput.value.trim();
      if (raw === "") {
        setErr("Enter a Book ID.");
        return;
      }
      const id = Number(raw);
      if (!Number.isInteger(id) || id < 0) {
        setErr("Enter a valid non-negative integer Book ID.");
        return;
      }
      highlightById(id);
    });


    // On input, ensure value is non-negative integer and strip leading zeros if desired
    highlightInput.addEventListener("input", (ev) => {
      let v = highlightInput.value;

      // Remove any characters that are not digits (failsafe)
      v = v.replace(/\D+/g, "");

      // Remove leading zeros (optional) but keep single "0"
      v = v.replace(/^0+(?=\d)/, "");

      highlightInput.value = v;
    });


    function highlightById(id) {
      const allNodes = nodesWrapper.querySelectorAll(".book-node");
      allNodes.forEach(n => n.classList.remove("highlight"));

      if (!id || isNaN(id)) {
        setErr("Enter a valid Book ID.");
        return;
      }

      let found = false;
      allNodes.forEach(n => {
        if (parseInt(n.dataset.bookId) === id) {
          n.classList.add("highlight");
          n.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
          found = true;
        }
      });

      if (!found) {
        // ❗ This will remain until you manually overwrite/clear it
        setErr(`Book with ID ${id} not found in current list.`);
        // we do NOT clear setMsg here so success text stays separate
      } else {
        // On success, clear previous error and show success message
        setErr("");
        setMsg(`Highlighted book with ID ${id}.`);
      }
    }

    highlightBtn.addEventListener("click", () => {
      const id = parseInt(highlightInput.value);
      highlightById(id);
    });

    refreshBtn.addEventListener("click", loadBooks);

    window.addEventListener("DOMContentLoaded", loadBooks);
  </script>
</body>
</html>
