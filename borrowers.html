<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Tracker – Borrowers</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="navbar">
      <div class="nav-left">
        <div class="nav-logo">L</div>
        <div>
          <div class="nav-title">Library Book Tracker</div>
          <div class="nav-subtitle">Linked List backend in C · MongoDB · Node.js</div>
        </div>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">Dashboard</a>
        <a href="add.html" class="nav-link">Add Book</a>
        <a href="issue.html" class="nav-link">Issue</a>
        <a href="return.html" class="nav-link">Return</a>
        <a href="delete.html" class="nav-link">Delete</a>
        <a href="borrowers.html" class="nav-link active">Borrowers</a>
      </nav>
    </header>

    <main>
      <div class="page-header">
        <div class="page-title">Borrowers List</div>
        <div class="page-subtitle">
          View all issued books along with student details, fetched from MongoDB.
        </div>
      </div>

      <section class="card">
        <div class="btn-row" style="justify-content: flex-end; margin-bottom: 8px;">
          <button class="btn secondary" id="refreshBtn" type="button">Refresh</button>
        </div>

        <div id="msg" class="status-message success"></div>
        <div id="err" class="status-message error"></div>

        <div class="table-wrapper">
          <table class="table" id="borrowersTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Book ID</th>
                <th>Book Title</th>
                <th>Student Name</th>
                <th>USN</th>
                <th>Issued At</th>
              </tr>
            </thead>
            <tbody id="borrowersBody">
              <!-- Rows will be inserted here -->
            </tbody>
          </table>
        </div>

        <p class="small-muted" style="margin-top:10px;">
          This table is built from the <code>issues</code> collection in MongoDB and linked to books by <code>bookId</code>.
        </p>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "http://localhost:3000/api";
    const tbody = document.getElementById("borrowersBody");
    const msg = document.getElementById("msg");
    const err = document.getElementById("err");
    const refreshBtn = document.getElementById("refreshBtn");

    function setMsg(t) { msg.textContent = t || ""; }
    function setErr(t) { err.textContent = t || ""; }

    function formatDate(d) {
      if (!d) return "-";
      const dt = new Date(d);
      if (isNaN(dt.getTime())) return d;
      return dt.toLocaleString();
    }

    async function loadBorrowers() {
      try {
        setErr("");
        setMsg("Loading borrowers from backend...");
        const res = await fetch(`${API_BASE}/issues`);
        if (!res.ok) throw new Error("Failed to load borrowers.");
        const data = await res.json();

        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          setMsg("No active issue records found.");
          return;
        }

        data.forEach((row, idx) => {
          const tr = document.createElement("tr");

          const tdIdx = document.createElement("td");
          tdIdx.textContent = idx + 1;
          tr.appendChild(tdIdx);

          const tdBookId = document.createElement("td");
          tdBookId.textContent = row.bookId;
          tr.appendChild(tdBookId);

          const tdTitle = document.createElement("td");
          tdTitle.textContent = row.bookTitle || "Unknown";
          tr.appendChild(tdTitle);

          const tdName = document.createElement("td");
          tdName.textContent = row.studentName;
          tr.appendChild(tdName);

          const tdUsn = document.createElement("td");
          tdUsn.textContent = row.usn;
          tr.appendChild(tdUsn);

          const tdIssued = document.createElement("td");
          tdIssued.textContent = formatDate(row.issuedAt);
          tr.appendChild(tdIssued);

          tbody.appendChild(tr);
        });

        setMsg(`Loaded ${data.length} issue record(s).`);
      } catch (e) {
        console.error(e);
        setMsg("");
        setErr(e.message || "Error loading borrowers.");
      }
    }

    refreshBtn.addEventListener("click", loadBorrowers);
    window.addEventListener("DOMContentLoaded", loadBorrowers);
  </script>
</body>
</html>
